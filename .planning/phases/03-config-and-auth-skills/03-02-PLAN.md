---
phase: 03-config-and-auth-skills
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - .agents/skills/nsyte-auth/SKILL.md
  - .agents/skills/nsyte-ci/SKILL.md
autonomous: true
requirements:
  - CONF-02
  - CONF-03

must_haves:
  truths:
    - "Agent can guide a user through connecting a NIP-46 bunker to nsyte"
    - "Agent knows both bunker connection methods: QR code scan and bunker URL"
    - "Agent can guide setting up CI/CD deployment with ephemeral credentials"
    - "Agent knows nsyte ci generates a one-time nbunksec that is never stored to disk"
    - "Agent understands that --sec (not --nbunksec) is the correct deploy flag"
    - "Interactive auth setup (nsyte-auth) and non-interactive CI deploy (nsyte-ci) instructions do not overlap"
  artifacts:
    - path: ".agents/skills/nsyte-auth/SKILL.md"
      provides: "Complete NIP-46 bunker auth skill body"
      contains: "nsyte bunker"
    - path: ".agents/skills/nsyte-ci/SKILL.md"
      provides: "Complete CI/CD deployment skill body"
      contains: "nsyte ci"
  key_links:
    - from: ".agents/skills/nsyte-auth/SKILL.md"
      to: ".agents/skills/nsyte-config/SKILL.md"
      via: "cross-reference for bunkerPubkey in config"
      pattern: "nsyte-config"
    - from: ".agents/skills/nsyte-ci/SKILL.md"
      to: ".agents/skills/nsyte-deploy/SKILL.md"
      via: "cross-reference for deploy command usage"
      pattern: "nsyte-deploy"
    - from: ".agents/skills/nsyte-ci/SKILL.md"
      to: ".agents/skills/nsyte-auth/SKILL.md"
      via: "cross-reference for initial bunker setup before CI"
      pattern: "nsyte-auth"
---

<objective>
Write the complete nsyte-auth and nsyte-ci skill bodies covering NIP-46 bunker authentication and non-interactive CI/CD deployment.

Purpose: An agent can guide users through two distinct auth workflows: (1) interactive bunker connection and management for development, and (2) one-time credential generation for headless CI/CD pipelines — with zero overlap between the two skills.

Output: `.agents/skills/nsyte-auth/SKILL.md` and `.agents/skills/nsyte-ci/SKILL.md` with full body content
</objective>

<execution_context>
@/home/sandwich/.claude/get-shit-done/workflows/execute-plan.md
@/home/sandwich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-config-and-auth-skills/03-RESEARCH.md
@.agents/skills/nsyte-deploy/SKILL.md
@.agents/skills/nsyte-auth/SKILL.md
@.agents/skills/nsyte-ci/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write nsyte-auth SKILL.md body</name>
  <files>.agents/skills/nsyte-auth/SKILL.md</files>
  <action>
Replace the placeholder comment in `.agents/skills/nsyte-auth/SKILL.md` with the full skill body. Preserve the existing frontmatter exactly. Follow the structural template from `nsyte-deploy/SKILL.md`.

The body MUST cover these sections:

**Prerequisites:**
- nsyte installed and in PATH (reference nsyte-setup skill)
- `.nsite/config.json` must exist (reference nsyte-config skill for config management)
- Interactive terminal required for all bunker commands (no CI/pipe support)
- Reference nsyte-concepts for NIP-46/bunker domain vocabulary

**Bunker Connection — Two Methods:**

Method 1: QR Code (Nostr Connect)
1. Run `nsyte bunker connect` with no URL
2. Choose "Scan QR Code (Nostr Connect)"
3. Enter relay (default: `wss://relay.nsec.app`)
4. QR code displayed in terminal
5. Scan with signer app (Amber, nsec.app, etc.)
6. Approve connection request in signer app
7. nsyte stores nbunksec in OS keychain

Method 2: Bunker URL
1. Get `bunker://...` URL from signer app
2. Run: `nsyte bunker connect 'bunker://pubkey?relay=wss://...&secret=...'`
3. CRITICAL: MUST use single quotes — shell metacharacters `?` and `&` break the URL without quoting
4. nsyte stores nbunksec in OS keychain

**Link Bunker to Project:**
- After connecting, run `nsyte bunker use [pubkey]` to set `bunkerPubkey` in `.nsite/config.json`
- This writes BOTH the config field AND the keychain entry atomically
- NEVER manually set `bunkerPubkey` in config — it creates a dangling reference without the keychain entry

**Bunker Management Subcommands:**
Table of all subcommands:

| Command | Purpose |
|---------|---------|
| `nsyte bunker connect` | Connect to a new bunker (QR or URL) |
| `nsyte bunker connect '<url>'` | Connect via bunker URL (single-quote required) |
| `nsyte bunker import nbunksec1...` | Import an existing nbunksec string |
| `nsyte bunker export [pubkey]` | Export stored bunker as nbunksec (for backup) |
| `nsyte bunker list` | List all stored bunkers |
| `nsyte bunker use [pubkey]` | Set current project to use a specific bunker |
| `nsyte bunker remove [pubkey]` | Remove a bunker from storage |
| `nsyte bunker migrate [pubkeys...]` | Rebuild index for keychain bunkers (upgrade/repair) |

**Secrets Storage:**
- Credentials stored automatically using OS-appropriate backend:
  - macOS: Keychain
  - Linux: Secret Service (or encrypted file fallback)
  - Windows: Credential Manager (or encrypted file fallback)
- Force encrypted file storage: set env `NSYTE_FORCE_ENCRYPTED_STORAGE=true`
- Legacy plain-text JSON (last-resort fallback, shows warning)

**Troubleshooting:**
- Bunker URL loses characters → single-quote the URL (shell metacharacters)
- "No stored credential" at deploy time → both config.json bunkerPubkey AND keychain entry must exist; re-run `nsyte bunker use`
- `bunkerPubkey` is always 64-char hex (not npub) — schema enforces `^[0-9a-fA-F]{64}$`

CRITICAL constraints:
- Do NOT include CI/CD deployment patterns (that is nsyte-ci territory)
- Do NOT include `--non-interactive` or `--sec` flag usage for deploys
- Do NOT include `nsyte ci` command documentation
- Keep under 200 lines body content
- Use `---` horizontal rules as section dividers
  </action>
  <verify>
    <automated>wc -l .agents/skills/nsyte-auth/SKILL.md | awk '{if ($1 > 5 && $1 < 210) print "PASS: " $1 " lines"; else print "FAIL: " $1 " lines"}'</automated>
    <manual>Verify body contains: Prerequisites, Connection Methods (QR + URL), Link to Project, Subcommand Table, Secrets Storage, Troubleshooting</manual>
  </verify>
  <done>nsyte-auth/SKILL.md has a complete body covering NIP-46 bunker connection (both methods), project linking, all management subcommands, and secrets storage. No CI/CD instructions present.</done>
</task>

<task type="auto">
  <name>Task 2: Write nsyte-ci SKILL.md body and validate both skills</name>
  <files>.agents/skills/nsyte-ci/SKILL.md</files>
  <action>
Replace the placeholder comment in `.agents/skills/nsyte-ci/SKILL.md` with the full skill body. Preserve the existing frontmatter exactly. Follow the structural template from `nsyte-deploy/SKILL.md`.

The body MUST cover these sections:

**Prerequisites:**
- nsyte installed on developer machine for credential generation (reference nsyte-setup)
- An existing bunker connection OR bunker URL from your signer app (reference nsyte-auth for setup)
- `.nsite/config.json` committed to repository or available in CI environment

**Step 1: Generate CI Credential (developer machine, one-time):**
- Run `nsyte ci` (interactive, prompts for connection method) OR
- Run `nsyte ci 'bunker://pubkey?relay=wss://...&secret=...'` (direct URL, single-quote required)
- This connects to the bunker and generates an ephemeral `nbunksec1...` string
- CRITICAL WARNING: The nbunksec is printed ONCE and NEVER stored to disk. Copy it immediately.
- Store the nbunksec in your CI platform's secrets manager (e.g., GitHub Actions secret named `NBUNK_SECRET`)

**Step 2: Configure CI Pipeline:**
- Deploy command for CI: `nsyte deploy ./dist --non-interactive --sec "${NBUNK_SECRET}"`
- CRITICAL: Use `--sec` flag (NOT `--nbunksec` — that flag does not exist despite README showing it)
- `--non-interactive` prevents the CLI from hanging on prompts in headless environments
- Exit codes: 0 = success, non-zero = failure

**GitHub Actions Example:**
```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: denoland/setup-deno@v1
      - run: nsyte deploy ./dist --non-interactive --sec "${{ secrets.NBUNK_SECRET }}"
```

**CI Pre-flight Checklist:**
Table:
| Check | How |
|-------|-----|
| Config exists | `.nsite/config.json` in repo or pipeline artifact |
| Secret set | `NBUNK_SECRET` env var contains `nbunksec1...` string |
| Non-interactive flag | `--non-interactive` present in deploy command |
| Validate config | `nsyte validate` (optional pre-deploy check, exits 1 on invalid) |

**Partial Success Handling:**
- Deploy exits 0 even on partial success (some servers failed)
- Check the `N/M files uploaded` line in output for true success count
- For strict CI: parse output and fail if N < M

CRITICAL constraints:
- Do NOT include interactive bunker connection steps (that is nsyte-auth territory)
- Do NOT include `nsyte config` TUI instructions (that is nsyte-config territory)
- Do NOT include `nsyte bunker connect/import/export/use/list/remove` documentation
- Keep under 150 lines body content (simpler skill)
- Use `---` horizontal rules as section dividers

After writing nsyte-ci, validate BOTH skill files:
1. Confirm frontmatter `name` fields match directory names exactly (`nsyte-auth`, `nsyte-ci`)
2. Confirm no `nsyte login` references in either file
3. Confirm no `--nbunksec` flag in either file (use `--sec`)
4. Confirm nsyte-auth has NO CI/deploy patterns (no `--non-interactive`, no `nsyte ci`, no GitHub Actions)
5. Confirm nsyte-ci has NO interactive bunker management steps (no `nsyte bunker connect/import/export/use/list/remove`)
6. Confirm cross-references: nsyte-auth references nsyte-config and nsyte-concepts; nsyte-ci references nsyte-auth and nsyte-deploy
  </action>
  <verify>
    <automated>wc -l .agents/skills/nsyte-ci/SKILL.md | awk '{if ($1 > 5 && $1 < 160) print "PASS: " $1 " lines"; else print "FAIL: " $1 " lines"}' && grep -c "\-\-nbunksec" .agents/skills/nsyte-auth/SKILL.md .agents/skills/nsyte-ci/SKILL.md | awk -F: '{if ($2 != "0") print "FAIL: --nbunksec found in " $1}'</automated>
    <manual>Verify no cross-contamination: nsyte-auth has zero CI content, nsyte-ci has zero interactive bunker management content</manual>
  </verify>
  <done>nsyte-ci/SKILL.md has a complete body covering credential generation, CI pipeline configuration, GitHub Actions example, and pre-flight checklist. nsyte-auth/SKILL.md has zero CI content. nsyte-ci/SKILL.md has zero interactive bunker management content. Both use --sec (not --nbunksec).</done>
</task>

</tasks>

<verification>
1. `.agents/skills/nsyte-auth/SKILL.md` exists with complete body (not stub)
2. `.agents/skills/nsyte-ci/SKILL.md` exists with complete body (not stub)
3. nsyte-auth covers: bunker connection (QR + URL), project linking, subcommand reference, secrets storage
4. nsyte-ci covers: credential generation, CI deploy pattern, GitHub Actions example, pre-flight checklist
5. Zero cross-contamination between the two skills
6. No `--nbunksec` flag in either file
7. No `nsyte login` in either file
8. Frontmatter names match directory names exactly
</verification>

<success_criteria>
An agent reading nsyte-auth SKILL.md can guide a user through connecting a NIP-46 bunker and linking it to their project. An agent reading nsyte-ci SKILL.md can guide a user through generating a CI credential and configuring a GitHub Actions pipeline. Neither skill contains instructions that belong to the other.
</success_criteria>

<output>
After completion, create `.planning/phases/03-config-and-auth-skills/03-02-SUMMARY.md`
</output>
